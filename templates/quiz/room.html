{% extends "base.html" %}
{% load env_tags %}
{% block title %}{{ quiz.title }}{% endblock %}

{% block content %}
    <style>
        .answer-btn {
            width: 45%;
            height: 150px;
            font-size: 3rem;
            margin: 5px;
        }
    </style>

    <h2 id="welcome-text">Welcome, {{ player_name }}!</h2>
    <h3 id="status-text">Waiting for the host to start the game...</h3>

    <div id="answers-container" style="display: none;">
        <button id="btn-a" onclick="sendAnswer('A')" class="answer-btn" style="background-color: red;"></button>
        <button id="btn-b" onclick="sendAnswer('B')" class="answer-btn" style="background-color: blue;"></button>
        <br>
        <button id="btn-c" onclick="sendAnswer('C')" class="answer-btn" style="background-color: orange;"></button>
        <button id="btn-d" onclick="sendAnswer('D')" class="answer-btn" style="background-color: green;"></button>
    </div>

    <script>
        const roomCode = "{{ session.code }}";
        const playerName = "{{ player_name }}";
        const host = "{% get_env_var 'SERVER_HOST_PC' %}";
        const socket = new WebSocket(`ws://${host}/ws/quiz/${roomCode}/`);

        const welcomeText = document.getElementById('welcome-text');
        const statusText = document.getElementById('status-text');
        const answersContainer = document.getElementById('answers-container');
        const answerButtons = answersContainer.getElementsByClassName('answer-btn');

        socket.onopen = () => {
            console.log("âœ… Player connected!");
            socket.send(JSON.stringify({'type': 'join', 'name': playerName}));
        };

        socket.onmessage = (e) => {
            const data = JSON.parse(e.data);
            console.log("Player received:", data);

            if (data.type === 'new_question') {
                document.body.style.backgroundColor = 'white';
                welcomeText.style.display = 'none';
                statusText.textContent = 'Choose your answer now!';
                answersContainer.style.display = 'block';

                for (let btn of answerButtons) {
                    btn.disabled = false;
                }
            } 
            else if (data.type === 'round_results') {
                const myResult = data.results[playerName];
                console.log("My result:", myResult);
                if (myResult === true) {
                    statusText.textContent = 'Correct!';
                    document.body.style.backgroundColor = 'lightgreen';
                } else {
                    statusText.textContent = 'Incorrect!';
                    document.body.style.backgroundColor = 'lightcoral';
                }
            }
            else if (data.type === 'quiz_end') {
                setTimeout(() => {
                    document.body.style.backgroundColor = 'white';
                    statusText.textContent = 'The quiz has ended. Thank you for playing!';
                    answersContainer.style.display = 'none';
                }, 3000);
            }
        };

        function sendAnswer(answer) {
            console.log(`Sending answer: ${answer}`);
            socket.send(JSON.stringify({'type': 'answer', 'answer': answer}));

            answersContainer.style.display = 'none'; 

            statusText.textContent = 'Answer sent! Waiting for the next question...';
        }
    </script>
{% endblock %}